systemMode emergency_stop

node lidar : SensorLidar
  topic scan = "perception/scan_data" : float
  topic alarm = "perception/obstacle" : bool

  func internalFilter(raw: float) -> float
    return raw

  onRequest startScan(rate: int) -> bool
    scan.publish(10.5)
    return true

  onRequest checkPath() -> bool
    alarm.publish(true)
    return false

node planner : NavStack
  topic cmd_vel = "navigation/velocity" : float
  topic status = "navigation/status" : string

  onListen lidar.scan handleScan(dist: float)
    calculatePath(dist)

  onListen lidar.alarm handleObstacle(danger: bool)
    status.publish("BLOCKED")
    request silent motors.halt()

  func calculatePath(d: float) -> bool
    cmd_vel.publish(0.8)
    return true

  onRequest getPlan() -> string
    return "Waypoints..."

node motors : DriveController
  topic odometry = "drive/odom" : float
  topic state = "drive/status" : int

  onListen planner.cmd_vel setVelocity(v: float)
    runPID(v)

  func runPID(target: float) -> int
    odometry.publish(target)
    return 1

  onRequest halt() -> bool
    return true

  func reportStatus(s: int) -> bool
    state.publish(s)
    return true

node dashboard : UI
  onListen planner.status showStatus(msg: string)
    log(msg)

  onListen motors.odometry updateMap(pos: float)
    render(pos)

  func log(m: string) -> int
    return 1

  func render(p: float) -> bool
    return true

mode planner->normal
  request lidar.startScan(20)

mode motors->normal
  reportStatus(1)

mode planner->emergency_stop
  request motors.halt()