systemMode Launch
systemMode Orbit
systemMode Deorbit

/* Complex Integration Test: Orbital Satellite Architecture
   Features: Scoped Listeners, Delegation, Isolation, Controllers
*/

node controller OBC : MainComputer
  topic state = "sys/state" : string
  topic altitude = "sys/alt" : float
  topic abort = "sys/abort" : bool

  onRequest initiateLaunch() -> bool
    state.publish("LAUNCH_SEQUENCE")
    transition system "Launch"
    return true

  onRequest stabilize() -> bool
    state.publish("STABLE")
    transition system "Orbit"
    return true

  onRequest triggerDeorbit() -> bool
    transition system "Deorbit"
    return true

  onRequest emergencyStop() -> bool
    abort.publish(true)
    transition system "Shutdown"
    return true

node Gyroscope : IMU
  topic raw_z = "sense/z" : float

  // Delegation: Routes data directly to private function
  onListen OBC.altitude do adjustSensitivity()

  func adjustSensitivity(alt: float) -> bool
    return true

  onRequest calibrate() -> bool
    transition "Calibrating"
    return true

  func internalRead() -> float
    raw_z.publish(-0.05)
    return -0.05

node Thrusters : Propulsion ignore system
  topic fuel = "prop/fuel" : int
  topic active = "prop/active" : bool

  onListen OBC.abort hardStop(panic: bool)
    active.publish(false)

  onRequest fire(duration: int) -> bool
    active.publish(true)
    consume(duration)
    return true

  func consume(amount: int) -> int
    fuel.publish(amount)
    return 0

node Radio : CommLink
  topic uplink = "comm/rx" : string

  onRequest sendTelemetry() -> bool
    uplink.publish("ACK")
    return true

  func filterNoise(s: string) -> bool
    return true

  func deepSleep(ignore_val: bool) -> bool
    return true

mode OBC->Init
  state.publish("BOOT")
  altitude.publish(0.0)

mode Gyroscope->Calibrating
  onListen OBC.state checkPhase(s: string)
    transition "Idle"

mode Gyroscope->Orbit
  request Radio.sendTelemetry()
  internalRead()

mode Thrusters->Active
  request OBC.stabilize()

mode Radio->Launch
  onListen OBC.state do filterNoise()

mode Radio->Shutdown
  onListen OBC.abort do deepSleep()

mode OBC->Deorbit
  request Thrusters.fire(100)